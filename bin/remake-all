#! /bin/bash

NPROC=$(if [ "$(uname -s)" = "Darwin" ]; then /usr/sbin/sysctl -n hw.logicalcpu; else /usr/bin/nproc; fi)
TAG=$(cat "${ACMACSD_ROOT}/share/tag")
PACKAGES_FILE=$(python3 -c "import os; print(os.path.dirname(os.path.realpath(\"$0\")) + '/../packages.$TAG')")

trap "{ echo FAILED >&2; exit 1; }" ERR

if command -v gmake >/dev/null 2>&1; then MAKE=gmake; else MAKE=make; fi

for package in $(cat "${PACKAGES_FILE}"); do
    pushd "${ACMACSD_ROOT}/sources/${package}"
    if [[ "${package}" == "acmacs.r" ]]; then
        OUTPUT_SYNC=""
    else
        OUTPUT_SYNC="--output-sync"
    fi
    ${MAKE} clean
    ${MAKE} ${OUTPUT_SYNC} -j${NPROC} -k "$@" install
    ${MAKE} ${OUTPUT_SYNC} -j${NPROC} "$@" test
    popd
done
